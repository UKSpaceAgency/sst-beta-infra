<!DOCTYPE html>
<html>
<head>
    <style>
        .container {
            width: 50%;
            margin: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        table, th, td {
            border: 1px solid black;
            padding: 5px;
        }
        th {
            text-align: left;
        }
        h3 {
            color: blue;
        }
    </style>
</head>
<body>

<h2 style="text-align: center;">Deployment History</h2>

<div id="content" class="container"></div>

<script type="module">
    // This is the URL to your S3 bucket, replace this with your actual URL
    //const S3_BUCKET_URL = 'https://deployment-history-mys-dev.s3.eu-west-2.amazonaws.com/';
    import { S3_BUCKET_URL } from './config.js';


    fetch(S3_BUCKET_URL)
    .then(response => response.text())
    .then(data => {
        // Use DOM parser to get the file links
        let parser = new DOMParser();
        let xmlDoc = parser.parseFromString(data, "text/xml");

        // Extract all keys from the S3 bucket XML
        let keys = xmlDoc.getElementsByTagName('Key');
        let promises = [];

        // Loop through keys and fetch each file
        for(let i = 0; i < keys.length; i++) {
            let fileName = keys[i].childNodes[0].nodeValue;
            if (fileName.endsWith('.txt')) {
                let fileUrl = S3_BUCKET_URL + fileName;
                promises.push(
                    fetch(fileUrl).then(response => {
                        let lastModified = new Date(response.headers.get('last-modified'));
                        return response.text().then(content => ({lastModified, content}));
                    })
                );
            }
        }

        return Promise.all(promises);
    })
    .then(files => {
        // Sort files based on 'last-modified' date
        files.sort((a, b) => b.lastModified - a.lastModified);

        let html = '';
        let currentMonth = '';
        let count = 0;

        files.forEach((file, index) => {
            let lines = file.content.split('\n');
            let month = file.lastModified.toLocaleString('default', { month: 'long', year: 'numeric' });

            if (month !== currentMonth) {
                if (index !== 0) {
                    html += '</table>';
                }

                currentMonth = month;
                count = 1;
                html += `<h3>${currentMonth} (Deployments: ${count})</h3><table><tr><th>Date</th><th>Commit ID</th><th>Environment Name</th></tr>`;
            } else {
                count++;
                html = html.replace(`(Deployments: ${count - 1})`, `(Deployments: ${count})`);
            }

            html += '<tr><td>' + lines[0] + '</td><td>' + lines[1] + '</td><td>' + lines[2] + '</td></tr>';
        });

        html += '</table>';
        document.getElementById('content').innerHTML = html;
    })
    .catch((error) => {
        console.error('Error:', error);
    });
</script>

</body>
</html>

